 /**************************
 * Time: 07.04.21 13:35:56 *
 * Host: iMac-P            *
 * User: undefined         *
 **************************/

(()=>{"use strict";var t={d:(o,e)=>{for(var n in e)t.o(e,n)&&!t.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:e[n]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};t.r(o),t.d(o,{default:()=>d});var __awaiter=function(t,o,e,n){return new(e||(e=Promise))((function(r,c){function fulfilled(t){try{step(n.next(t))}catch(t){c(t)}}function rejected(t){try{step(n.throw(t))}catch(t){c(t)}}function step(t){var o;t.done?r(t.value):(o=t.value,o instanceof e?o:new e((function(t){t(o)}))).then(fulfilled,rejected)}step((n=n.apply(t,o||[])).next())}))};if(!window.Fatcoupon||!window.Fatcoupon.ModulesImporter)throw Error("window.Fatcoupon.ModulesImporter not set, store connector injection failed");const{StoreConnector,StoreConnectorFunctionResult:e,StoreConnectorHelpers:n,MultipageStoreConnectorWrapper:r,Helpers:c,UIHelpers:a,Cookies:s,Settings:i,AjaxMethod:l,Logger:p,$:u}=window.Fatcoupon.ModulesImporter;window.Fatcoupon.StoreConnector=new r(new class extends StoreConnector{constructor(){super(...arguments),this.metadata={storeIds:{dev:["5f0feb27d9806b511cd432d7"],prod:["5ef16d7df627230011e687d9"]},pageSelector:".cart-wrapper,.checkout-wrapper",cartTotalSelector:".order-value .order-total-wrapper",couponAppliedNumber:2,reloadPageAfterApplying:!0,timeouts:{collectAndClearAppliedCoupons:2e4,getCartTotal:7e3,beforeApplyingCoupon:5e3,applyCoupon:2e4,afterApplyingCoupon:1e4}},this.functions={checkoutRequest:(t,o=!1)=>__awaiter(this,void 0,void 0,(function*(){let e;const n=new URL("https://us.ecco.com/checkout-review");n.searchParams.set("format","ajax"),Object.assign(t,this.context.formData);let{error:r,response:a}=yield c.ajax("POST",n.href,!1,{data:t});if(r)throw Error("ERROR: "+JSON.stringify(r));return u(a).find(".error").length?{discount:0}:(e=c.parseUsdString(u(a).find(this.metadata.cartTotalSelector).text()),o&&(this.context.total=e),this.functions.stackingCalc(e))})),stackingCalc:t=>{if(t<this.context.total){if(this.context.totalAfterApply&&t>=this.context.totalAfterApply)return this.context.couponsArr.push("dwfrm_promotions_coupons_i1_removeCouponCode"),{discount:0};this.context.stackNum++,this.context.totalAfterApply=t,console.log(t,`after ${this.context.stackNum} apply`)}else this.context.stackNum>0?this.context.couponsArr.push("dwfrm_promotions_coupons_i1_removeCouponCode"):this.context.couponsArr.push("dwfrm_promotions_coupons_i0_removeCouponCode");return this.context.stackNum===this.metadata.couponAppliedNumber?(this.context.total=this.context.totalAfterApply,{cartTotalAfterApply:this.context.total}):{discount:0}}},this.context={pathName:window.location.pathname.replace("/",""),formData:{},total:null,totalAfterApply:null,couponsArr:[],stackNum:0}}collectAndClearAppliedCoupons(){return __awaiter(this,void 0,void 0,(function*(){const t=[],o=u(".promotion-coupon-code");for(const e of o){const o=u(e).text();o&&t.includes(o)&&t.push(o)}const e=u(".remove-coupon");if(e.length){const t=u(e[0]).attr("name"),o={};o[t]=t;for(const t of e)yield this.functions.checkoutRequest(o,!0),yield c.wait(2*i.COUPON_APPLYING.DELAY_INSIDE_ACTION);console.log(this.context.total,"after delete")}return t}))}getCartTotal(){return __awaiter(this,void 0,void 0,(function*(){return this.context.total||(this.context.total=yield n.getCartTotalBySelector(this.metadata.cartTotalSelector),console.log(this.context.total,"get")),this.context.total}))}beforeApplyingCoupon(){}applyCoupon(t){return __awaiter(this,void 0,void 0,(function*(){if("FatCoupon"===t)return this.context.total=this.context.totalAfterApply,console.log(this.context.total||0,`after ${this.context.stackNum} apply`),this.context.total?{cartTotalAfterApply:this.context.total}:{discount:0};const o=u(".add-coupon").val(),e={couponCode:t};return e[o]=o,yield c.wait(2*i.COUPON_APPLYING.DELAY_INSIDE_ACTION),yield this.functions.checkoutRequest(e)}))}afterApplyingCoupon(){return __awaiter(this,void 0,void 0,(function*(){if(this.context.couponsArr.length){const t=new URL(location.origin+"/on/demandware.store/Sites-US-Site/en_US/Cart-RemoveCoupon");t.searchParams.set("format","ajax");for(let o of this.context.couponsArr){let e={};e[o]=o;const n=yield c.ajax("POST",t.href,!1,{data:e});if(n.error)throw Error("ERROR: "+JSON.stringify(n.error));n.response&&(u(".cart-wrapper-inner").replaceWith(u(n.response)),this.context.total=c.parseUsdString(u(n.response).find(this.metadata.cartTotalSelector).text()))}this.context.couponsArr.length=0}}))}}(!1)),p.borderedMessage("FatCoupon: store connector injected!","#a3cc91");const d=window.Fatcoupon.StoreConnector})();